<!DOCTYPE html>
<!--
    So Simple Jekyll Theme 3.2.0
    Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
    Free for personal and commercial use under the MIT license
    https://github.com/mmistakes/so-simple-theme/blob/master/LICENSE
-->
<html lang="en-US" class="no-js">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  

  
    <title>Banyan Bot Blue Part 2</title>
    <meta name="description" content="Preparing The Raspberry Pi For Bluetooth Communication">
    <link rel="canonical" href="http://localhost:4000/bots-in-pieces/banyan-bot-blue/bluetooth/bluetooth-test-server/2019/06/15/banyan-bot-blue-part-2.html">
  

  <script>
    /* Cut the mustard */
    if ( 'querySelector' in document && 'addEventListener' in window ) {
      document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + 'js';
    }
  </script>

  <link rel="stylesheet" href="/bots-in-pieces/assets/css/main.css">
  <link rel="stylesheet" href="/bots-in-pieces/assets/css/skins/default.css">
  <link rel="alternate" type="application/atom+xml" title="Bots In Pieces" href="/bots-in-pieces/atom.xml">
<!-- start custom head snippets -->

<!-- insert favicons. use http://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

</head>


  <body class="layout--post  banyan-bot-blue-part-2">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#primary-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    
  <div class="navigation-wrapper">
    <a href="#menu-toggle" id="menu-toggle">Menu</a>
    <nav id="primary-nav" class="site-nav animated drop">
      <ul><li><a href="/bots-in-pieces/">Home</a></li><li><a href="/bots-in-pieces/posts/">Posts</a></li><li><a href="/bots-in-pieces/categories/">Categories</a></li><li><a href="/bots-in-pieces/tags/">Tags</a></li><li><a href="/bots-in-pieces/search/">Search</a></li><li><a href="/bots-in-pieces/about/">Commenting Policy</a></li></ul>
    </nav>
  </div><!-- /.navigation-wrapper -->


    <header class="masthead">
  <div class="wrap">
    
      <a href="/bots-in-pieces/" class="site-logo" rel="home" title="Bots In Pieces">
        <img src="/bots-in-pieces/images/logo.png" class="site-logo-img animated fadeInDown" alt="Bots In Pieces">
      </a>
    
    
    
      
        <div class="site-title animated fadeIn"><a href="/bots-in-pieces/">Bots In Pieces</a></div>
      
      <p class="site-description animated fadeIn" itemprop="description">Physical Computing (And Other Topics) In Easy To Digest "Byte-Size" Morsels</p>
    
  </div>
</header><!-- /.masthead -->


    <main id="main" class="main-content" aria-label="Content">
  <article class="h-entry">
    

    <div class="page-wrapper">
      <header class="page-header">
        
        
          <h1 id="page-title" class="page-title p-name">Banyan Bot Blue Part 2
</h1>
        
      </header>

      <div class="page-sidebar">
        <div class="page-author h-card p-author"><img src="/bots-in-pieces/images/MrYsLab.png" class="author-avatar u-photo" alt="Alan Yorinks"><div class="author-info"><div class="author-name">
        <span class="p-name">Alan Yorinks</span>
      </div><ul class="author-links"><li class="author-link">
            <a class="u-url" rel="me" href="https://twitter.com/BrassFigLigee"><i class="fab fa-twitter-square fa-lg" title="Twitter"></i></a>
          </li><li class="author-link">
            <a class="u-url" rel="me" href="https://github.com/MrYsLab"><i class="fab fa-github-square fa-lg" title="GitHub"></i></a>
          </li></ul>

<span class="read-time">4 min read</span>

    <time class="page-date dt-published" datetime="2019-06-15T07:55:39-04:00"><a class="u-url" href="">June 15, 2019</a>
</time>

  </div>
</div>

        
  <h3 class="page-taxonomies-title">Categories</h3>
  <ul class="page-taxonomies"><li class="page-taxonomy">Banyan-Bot-Blue</li><li class="page-taxonomy">Bluetooth</li><li class="page-taxonomy">Bluetooth-test-server</li>
  </ul>


        
  <h3 class="page-taxonomies-title">Tags</h3>
  <ul class="page-taxonomies"><li class="page-taxonomy">pip</li><li class="page-taxonomy">pybluez</li>
  </ul>


      </div>

      <div class="page-content">
        <div class="e-content">
          <h1 id="preparing-the-raspberry-pi-for-bluetooth-communication">Preparing The Raspberry Pi For Bluetooth Communication</h1>

<h1 id="in-this-edition-of-bots-in-pieces-we-will">In this edition of <em>Bots In Pieces</em>, we will:</h1>

<ol>
  <li>Configure the Raspberry Pi for Bluetooth RFCOMM communications.</li>
  <li>Explain how to pair an Android device with the Raspberry Pi.</li>
  <li>Install the <a href="https://github.com/pybluez/pybluez"><em>pybluez</em></a> Python package.</li>
  <li>Install a Bluetooth Server test tool.</li>
</ol>

<blockquote>
  <p><strong>Don’t have an Android device? Not to worry!</strong></p>

  <p>In a future post, a <em>tkinter</em> component will be presented that can be
used to replace the Android app and Bluetooth server. This will allow you
to drive the robot directly on the Raspberry Pi desktop.</p>
</blockquote>

<h2 id="configuring-the-raspberry-pi-bluetooth-and-rfcomm-communications">Configuring The Raspberry Pi, Bluetooth, and RFCOMM Communications.</h2>

<p>As you will see, the process is pretty simple to do. Just follow the simple steps below.</p>

<h2 id="enabling-the-raspberry-pi-for-pairing">Enabling The Raspberry Pi For Pairing.</h2>

<h3 id="step-1-update-raspbian---open-a-terminal-and-type">Step 1: Update Raspbian - open a terminal and type:</h3>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">sudo apt-get update
sudo apt-get upgrade
</span></code></pre></div></div>

<h3 id="step-2-in-the-terminal-type-the-following">Step 2: In the terminal type the following:</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo rfkill unblock all
</code></pre></div></div>

<p>This will unblock the Bluetooth device on your RPi if it is in a blocked state.</p>

<h3 id="step-3-invoke-the-bluetoothctl-program">Step 3: Invoke the <em>bluetoothctl</em> program:</h3>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">sudo bluetoothctl
</span></code></pre></div></div>

<p>Then enter the following three commands:</p>

<p><strong>power on</strong><br />
<strong>discoverable on</strong><br />
<strong>pairable on</strong></p>

<p>You should see something like the following in your terminal:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pi@BanyanBot:~ $ sudo bluetoothctl
[NEW] Controller B8:27:EB:25:1A:EA BanyanBot [default]
[bluetooth]# power on
Changing power on succeeded
[bluetooth]# discoverable on
Changing discoverable on succeeded
[bluetooth]# pairable on
Changing pairable on succeeded
[bluetooth]# 

</code></pre></div></div>

<p>When first starting <em>bluetoothctl</em> the first line displays the RPi’s Bluetooth MAC address
and hostname.</p>

<p>For each of the 3 commands, the tool will indicate success or failure.</p>

<h2 id="pairing-the-raspberry-pi-to-an-android-device">Pairing The Raspberry Pi To An Android Device</h2>
<p>Consult your Android Device Manual for exact instructions. I am 
using a Kindle Fire Tablet as an example.</p>

<ol>
  <li>
    <p>Power On your Android Device.</p>
  </li>
  <li>
    <p>Go to the device’s settings for Bluetooth and turn Bluetooth On.
<img src="/bots-in-pieces/images/banyan-bot-blue-1/android_settings/android1.jpg" alt="" /></p>
  </li>
  <li>
    <p>Select “Pair A Bluetooth Device.</p>
  </li>
  <li>
    <p>Perform a scan for Bluetooth devices and select the hostname of your Raspberry Pi when the scan completes.
<img src="/bots-in-pieces/images/banyan-bot-blue-1/android_settings/android2.jpg" alt="" /></p>
  </li>
  <li>
    <p>You should see that the Android device is now paired with your Raspberry Pi
<img src="/bots-in-pieces/images/banyan-bot-blue-1/android_settings/android3.jpg" alt="" /></p>
  </li>
  <li>
    <p>If you go back to the Raspberry Pi, and look at the output on bluetoothctl, you should
see something that looks like the following:</p>
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">[bluetooth]#</span><span class="w"> </span>power on
<span class="go">Changing power on succeeded
</span><span class="gp">[bluetooth]#</span><span class="w"> </span>discoverable on
<span class="go">Changing discoverable on succeeded
[CHG] Controller B8:27:EB:25:1A:EA Discoverable: yes
</span><span class="gp">[bluetooth]#</span><span class="w"> </span>pairable on
<span class="go">Changing pairable on succeeded
[NEW] Device 00:BB:3A:06:A0:24 Alan's Kindle HDX
[CHG] Device 00:BB:3A:06:A0:24 Modalias: bluetooth:v001Dp1200d1436
[CHG] Device 00:BB:3A:06:A0:24 UUIDs: 0000110a-0000-1000-8000-00805f9b34fb
[CHG] Device 00:BB:3A:06:A0:24 UUIDs: 0000110c-0000-1000-8000-00805f9b34fb
[CHG] Device 00:BB:3A:06:A0:24 UUIDs: 00001200-0000-1000-8000-00805f9b34fb
[CHG] Device 00:BB:3A:06:A0:24 UUIDs: 00001800-0000-1000-8000-00805f9b34fb
[CHG] Device 00:BB:3A:06:A0:24 UUIDs: 00001801-0000-1000-8000-00805f9b34fb
[CHG] Device 00:BB:3A:06:A0:24 ServicesResolved: yes
[CHG] Device 00:BB:3A:06:A0:24 Paired: yes
[CHG] Device 00:BB:3A:06:A0:24 ServicesResolved: no
[CHG] Device 00:BB:3A:06:A0:24 Connected: no
</span></code></pre></div>    </div>
  </li>
</ol>

<p>It shows that pairing was successful. Notice that we are not connected yet.</p>

<h2 id="enabling-the-raspberry-pi-for-rfcomm-serial-communication">Enabling The Raspberry Pi For RFCOMM Serial Communication.</h2>

<ol>
  <li>Close the bluetoothctl tool by either entering <em>exit</em> or pressing Control-D.</li>
</ol>

<ol start="2">
  <li>We are about to make some changes to the <br />
<strong>/etc/systemd/system/dbus-org.bluez.service</strong> file.</li>
</ol>

<p>Before doing so, let’s make a back-up copy of the file in case anything goes wrong. In the terminal you have open
type:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo cp /etc/systemd/system/dbus-org.bluez.service /etc/systemd/system/dbus-org.bluez.service.BACKUP
</code></pre></div></div>
<p>This is a very long line so make sure that you copy it all.</p>

<ol start="3">
  <li>Now we need to make changes to the file. We will modify one line and add a new line.
Open up the file with your favorite editor using sudo privileges:</li>
</ol>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">sudo nano /etc/systemd/system/dbus-org.bluez.service
</span></code></pre></div></div>

<ol start="4">
  <li>Here is what the file may look like:</li>
</ol>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">[Unit]
Description=Bluetooth service
Documentation=man:bluetoothd(8)
ConditionPathIsDirectory=/sys/class/bluetooth

[Service]
Type=dbus
BusName=org.bluez
ExecStart=/usr/lib/bluetooth/bluetoothd
NotifyAccess=main
</span><span class="gp">#</span><span class="nv">WatchdogSec</span><span class="o">=</span>10
<span class="gp">#</span><span class="nv">Restart</span><span class="o">=</span>on-failure
<span class="go">CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
LimitNPROC=1
ProtectHome=true
ProtectSystem=full

[Install]
WantedBy=bluetooth.target
Alias=dbus-org.bluez.service
</span></code></pre></div></div>

<ol start="5">
  <li>In the third line in the [Service] section, we need to add <strong>-C</strong> to the end of the line. Change:</li>
</ol>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">ExecStart=/usr/lib/bluetooth/bluetoothd
</span></code></pre></div></div>
<p>to:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ExecStart=/usr/lib/bluetooth/bluetoothd -C
</code></pre></div></div>

<ol start="6">
  <li>And right below that line, we need to add the following new line:
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">ExecStartPost=/usr/bin/sdptool add SP
</span></code></pre></div>    </div>
  </li>
</ol>

<p>The [Service] section should now look like:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">[Service]
Type=dbus
BusName=org.bluez
ExecStart=/usr/lib/bluetooth/bluetoothd -C
ExecStartPost=/usr/bin/sdptool add SP
NotifyAccess=main
</span><span class="gp">#</span><span class="nv">WatchdogSec</span><span class="o">=</span>10
<span class="gp">#</span><span class="nv">Restart</span><span class="o">=</span>on-failure
<span class="go">CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
LimitNPROC=1
ProtectHome=true
ProtectSystem=full
</span></code></pre></div></div>

<ol start="7">
  <li>Save the file and exit the editor.</li>
  <li>Reboot the Raspberry Pi.</li>
</ol>

<h1 id="installing-a-bluetooth-test-server">Installing A Bluetooth Test Server</h1>

<p>In the next post, we will be connecting an Android app to our Raspberry Pi using
Bluetooth. This app requires a Bluetooth server to be running on the RPi, and so
let’s install one now.</p>

<h2 id="first-lets-update-pip-to-the-latest-and-greatest">First, Let’s Update <em>pip</em> To The Latest And Greatest.</h2>

<p>The server requires the <a href="https://github.com/pybluez/pybluez"><em>pybluez</em></a> Python package to
be installed on the Raspberry Pi. Before doing so, let’s take the opportunity to update
<em>pip</em> on the RPi to the latest version. If you are running Raspbian Buster you can skip this step.</p>

<p>Open a terminal window on your Raspberry Pi and type the following command:</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">sudo pip3 install -U pip
</span></code></pre></div></div>
<h2 id="install-the-pybluez-library">Install The <em>pybluez</em> Library</h2>

<p>First install the required libraries for pybluez.
In your console type:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install </span>libbluetooth-dev
</code></pre></div></div>

<p>Next, in your console type:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo pip3 install pybluez
</code></pre></div></div>

<h2 id="copy-the-test-server-to-your-raspberry-pi">Copy The Test Server To Your Raspberry Pi</h2>
<p>The source code for the server <a href="https://github.com/MrYsLab/bots-in-pieces-examples/blob/master/banyan-bot-blue/test_fixtures/bluetooth_apk_validation_server.py"><em>may be found at this link</em>.</a>
Create a <em>banyan-bot-blue</em> directory on your Raspberry Pi, then create a <em>test_fixtures</em> directory. Copy the test
server to that directory.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">banyan-bot-blue
└── test_fixtures
    └── bluetooth_apk_validation_server.py
</span></code></pre></div></div>

<p>If you look at the server code you will see that the server initially prints out a
message that it is waiting for a client to connect.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">bluetooth</span>


<span class="k">print</span><span class="p">(</span><span class="s">'Waiting for client to connect...'</span><span class="p">)</span>
<span class="n">server_sock</span> <span class="o">=</span> <span class="n">bluetooth</span><span class="p">.</span><span class="n">BluetoothSocket</span><span class="p">(</span><span class="n">bluetooth</span><span class="p">.</span><span class="n">RFCOMM</span><span class="p">)</span>

<span class="n">port</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">server_sock</span><span class="p">.</span><span class="n">bind</span><span class="p">((</span><span class="s">""</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
<span class="n">server_sock</span><span class="p">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<p>After a successful connection, it sends
a short text message to the client and then sits in a loop receiving data from the
client and printing the data to the console.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">client_sock</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="n">server_sock</span><span class="p">.</span><span class="n">accept</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Accepted connection from "</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="s">'Hello Banyan Bot'</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">encode</span><span class="p">()</span>
<span class="n">client_sock</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">client_sock</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)).</span><span class="n">decode</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s">"received [%s]"</span> <span class="o">%</span> <span class="n">data</span><span class="p">)</span>
</code></pre></div></div>

<p>To run the server it must be invoked with sudo:</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">sudo python3 bluetooth_apk_validation_server.py

</span></code></pre></div></div>
<p>You should see the <em>Waiting for client to connect…</em> message.
You can then kill the server.</p>

<h3 id="that-concludes-this-post-next-time---we-build-an-android-app-to-control-the-robot-and-connect-it-to-the-server">That concludes this post. Next time - we build an Android app to control the robot and connect it to the server.</h3>


        </div>

        
          <div class="page-share">
  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2Fbots-in-pieces%2Fbanyan-bot-blue%2Fbluetooth%2Fbluetooth-test-server%2F2019%2F06%2F15%2Fbanyan-bot-blue-part-2.html" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" class="btn btn--facebook btn--small"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i> <span>Share</span></a>
  <a href="https://twitter.com/intent/tweet?text=Banyan+Bot+Blue+Part+2%20http%3A%2F%2Flocalhost%3A4000%2Fbots-in-pieces%2Fbanyan-bot-blue%2Fbluetooth%2Fbluetooth-test-server%2F2019%2F06%2F15%2Fbanyan-bot-blue-part-2.html" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" class="btn btn--twitter btn--small"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i> <span>Tweet</span></a>
  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Fbots-in-pieces%2Fbanyan-bot-blue%2Fbluetooth%2Fbluetooth-test-server%2F2019%2F06%2F15%2Fbanyan-bot-blue-part-2.html" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" class="btn btn--linkedin btn--small"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> <span>LinkedIn</span></a>
  <a href="https://reddit.com/submit?title=Banyan+Bot+Blue+Part+2&url=http%3A%2F%2Flocalhost%3A4000%2Fbots-in-pieces%2Fbanyan-bot-blue%2Fbluetooth%2Fbluetooth-test-server%2F2019%2F06%2F15%2Fbanyan-bot-blue-part-2.html" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" class="btn btn--reddit btn--small"><i class="fab fa-fw fa-reddit" aria-hidden="true"></i> <span>Reddit</span></a>
</div>

        

        
          

        

        <nav class="page-pagination" role="navigation">
  
    <a class="page-previous" href="/bots-in-pieces/banyan-bot-blue/python-banyan/2019/06/10/banyan-bot-blue-part-1.html">
      <h4 class="page-pagination-label">Previous</h4>
      <span class="page-pagination-title">
        <i class="fas fa-arrow-left"></i> Banyan Bot Blue: Part 1

      </span>
    </a>
  

  
    <a class="page-next" href="/bots-in-pieces/banyan-bot-blue/android/bluetooth/2019/06/16/banyan-bot-blue-part-3.html">
      <h4 class="page-pagination-label">Next</h4>
      <span class="page-pagination-title">
        Banyan Bot Blue Part 3
 <i class="fas fa-arrow-right"></i>
      </span>
    </a>
  
</nav>

      </div>
    </div>
  </article>
</main>


    <footer id="footer" class="site-footer">
  <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
<div class="social-icons"><a class="social-icon" href="https://twitter.com/BrassFigLigee"><i class="fab fa-twitter-square fa-2x" title="Twitter"></i></a><a class="social-icon" href="https://github.com/MrYsLab"><i class="fab fa-github-square fa-2x" title="GitHub"></i></a><a class="social-icon" href="/bots-in-pieces/atom.xml"><i class="fas fa-rss-square fa-2x" title="Feed"></i></a></div><div class="copyright">
    
      <p>Copyright (C) 2019-2021 Alan Yorinks. All Rights Reserved.</p>

    
  </div>
</footer>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <script src="/bots-in-pieces/assets/js/main.min.js"></script>
  <script src="https://use.fontawesome.com/releases/v5.0.12/js/all.js"></script>


  </body>

</html>
